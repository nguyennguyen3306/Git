<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.0.min.js"
      integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
      crossorigin="anonymous"
    ></script>
    <script src="
https://cdn.jsdelivr.net/npm/sweetalert2@11.7.20/dist/sweetalert2.all.min.js
"></script>
  </head>
  <body>
    <!-- Modal -->
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel"></h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              placeholder="Email"
              id="email"
              class="form-control"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              id="loginbtn"
              data-bs-target="#loginModal"
            >
              Đăng nhập
            </button>
            <button type="button" class="btn btn-primary" id="logoutbtn">
              Đăng xuất
            </button>
            <button type="button" class="btn btn-primary" id="update">
              Cập nhật
            </button>
          </div>
        </div>
      </div>
    </div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Home</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a
                class="nav-link active"
                aria-current="page"
                href="#"
                data-bs-toggle="modal"
                data-bs-target="#exampleModal"
                id="login"
                >login</a
              >
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Loại sản phẩm
              </a>
              <ul
                class="dropdown-menu"
                aria-labelledby="navbarDropdown"
                id="listLSP"
              ></ul>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Thương Hiệu
              </a>
              <ul
                class="dropdown-menu"
                aria-labelledby="navbarDropdown"
                id="Brands"
              ></ul>
            </li>
          </ul>
          <form class="d-flex">
            <input
              class="form-control me-2"
              type="search"
              placeholder="Thêm to-do-task"
              aria-label="Search"
              id="todoinput"
            />
            <button
              class="btn btn-outline-success"
              type="submit"
              type="button"
              id="createTodo"
            >
              Thêm
            </button>
          </form>
        </div>
      </div>
    </nav>
    <div class="container w-70">
      <div class="table-responsive">
        <table class="table table-primary">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Tên todo</th>
              <th scope="col">Hoàn thành</th>
              <th scope="col">Tùy chỉnh</th>
            </tr>
          </thead>
          <tbody id="resulttask">
            <tr>
              <td scope="row">1</td>
              <td>todo</td>
              <td style="width: 20%">
                <input type="checkbox" name="" id="" />
              </td>
              <td style="width: 20%">
                <button
                  class="btn-sm btn-warning editbtn"
                  id="edittodo"
                  button
                  type="button"
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#exampleModal"
                >
                  Sửa
                </button>
                <button class="btn-sm btn-danger deletebtn">Xóa</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script>
      $("#logoutbtn").hide();
      $("#update").hide();

      $(document).ready(function () {
        loadpage();
        checklogin();
        login();
        logout();
        createTodo();
        loadtodo();
        update();
      });

      function edit() {
        $(".editbtn").click(function (e) {
          e.preventDefault();
          var old = $(this).attr("data-value");
          var id = $(this).attr("data-id");
          console.log(old, id);
          $("#email").val(old);
          $("#email").removeAttr("disabled", "readonly");
          $("#loginbtn").hide();
          $("#update").show();
          $("#logoutbtn").hide();
          $("#email").attr("placeholder", "");
          $("#update").click(function (e) {
              e.preventDefault();
              var todo = $("#email").val().trim();
            }).then( () => {
              reload();
            });
        });
      }

      // function delete(){
      //   $('.deletebtn').click(function (e) {
      //     e.preventDefault();

      //   });
      // }

      function loadtodo() {
        $.ajax({
          type: "get",
          url: "https://students.trungthanhweb.com/api/todo",
          data: {
            apitoken: localStorage.getItem("token"),
          },
          dataType: "JSON",
          success: function (res) {
            if (res.todo && res.todo.length > 0) {
              var str = ``;
              res.todo.forEach((el, key) => {
                if (el["status"] == 0) {
                  str +=
                    `
                <tr>
              <td scope="row">` +
                    ++key +
                    `</td>
              <td>` +
                    el["note"] +
                    `</td>
              <td style="width: 20%;">
                <input type="checkbox" name="" id="finishtaskinput" data-id="` +
                    el["id"] +
                    `">
              </td>
              <td style="width: 20%;">
                <button class="btn-sm btn-warning editbtn" button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-value="` +
                    el["note"] +
                    `" data-id="` +
                    el["id"] +
                    `">Sửa</button>
                <button class="btn-sm btn-danger deletebtn" data-id="` +
                    el["id"] +
                    `">Xóa</button>

              </td>
            </tr>
                `;
                } else {
                  str +=
                    `
                <tr>
              <td scope="row">` +
                    ++key +
                    `</td>
              <td>` +
                    el["note"] +
                    `</td>
              <td style="width: 20%;">
                <input type="checkbox" name="" id="finishtaskinput" disabled checked data-value="` +
                    el["note"] +
                    `" data-id="` +
                    el["id"] +
                    `">
              </td>
              <td style="width: 20%;">
                <button class="btn-sm btn-warning editbtn " button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-id="` +
                    el["id"] +
                    `">Sửa</button>
                <button class="btn-sm btn-danger deletebtn " data-id="` +
                    el["id"] +
                    `">Xóa</button>
              </td>
            </tr>
                `;
                }
              });
              $("#resulttask").html(str);
              edit();
              update();
            }
          },
        });
      }

      function createTodo() {
        $("#createTodo").click(function (e) {
          e.preventDefault();
          var todo = $("#todoinput").val().trim();
          if (todo == "") {
            const Toast = Swal.mixin({
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 1500,
              timerProgressBar: true,
              didOpen: (toast) => {
                toast.addEventListener("mouseenter", Swal.stopTimer);
                toast.addEventListener("mouseleave", Swal.resumeTimer);
              },
            });

            Toast.fire({
              icon: "error",
              title: "To do đang trống",
            });
          } else {
            if (
              localStorage.getItem("token") &&
              localStorage.getItem("token") != null
            ) {
              var apitoken = localStorage.getItem("token");
              $.ajax({
                type: "post",
                url: "https://students.trungthanhweb.com/api/todo",
                data: {
                  apitoken: localStorage.getItem("token"),
                  todo: todo,
                },
                dataType: "JSON",
                success: function (response) {
                  if (response.check == true) {
                    const Toast = Swal.mixin({
                      toast: true,
                      position: "top-end",
                      showConfirmButton: false,
                      timer: 1500,
                      timerProgressBar: true,
                      didOpen: (toast) => {
                        toast.addEventListener("mouseenter", Swal.stopTimer);
                        toast.addEventListener("mouseleave", Swal.resumeTimer);
                      },
                    });

                    Toast.fire({
                      icon: "success",
                      title: "Thêm thành công",
                    }).then(() => {
                      reload();
                    });
                  }
                  if (response.msg.apitoken) {
                    const Toast = Swal.mixin({
                      toast: true,
                      position: "top-end",
                      showConfirmButton: false,
                      timer: 1500,
                      timerProgressBar: true,
                      didOpen: (toast) => {
                        toast.addEventListener("mouseenter", Swal.stopTimer);
                        toast.addEventListener("mouseleave", Swal.resumeTimer);
                      },
                    });

                    Toast.fire({
                      icon: "error",
                      title: response.msg.apitoken,
                    });
                  } else if (response.msg.todo) {
                    const Toast = Swal.mixin({
                      toast: true,
                      position: "top-end",
                      showConfirmButton: false,
                      timer: 1500,
                      timerProgressBar: true,
                      didOpen: (toast) => {
                        toast.addEventListener("mouseenter", Swal.stopTimer);
                        toast.addEventListener("mouseleave", Swal.resumeTimer);
                      },
                    });

                    Toast.fire({
                      icon: "error",
                      title: response.msg.todo,
                    });
                  }
                },
              });
            } else {
              const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true,
                didOpen: (toast) => {
                  toast.addEventListener("mouseenter", Swal.stopTimer);
                  toast.addEventListener("mouseleave", Swal.resumeTimer);
                },
              });

              Toast.fire({
                icon: "error",
                title: "Vui lòng đăng nhập",
              });
            }
          }
        });
      }

      function checklogin() {
        $(document).ready(function () {
          if (
            localStorage.getItem("token") &&
            localStorage.getItem("token") != null
          ) {
            $("#logoutbtn").show();

            $("#loginbtn").attr("disabled", "disabled");
            $("#email").val(localStorage.getItem("token"));
            $("#email").attr("disabled", "readonly");
            $("#login").text("API");
          } else {
            $("#loginbtn").attr("disabled", false);
          }
          login();
        });
      }

      function logout() {
        $("#logoutbtn").click(function (e) {
          e.preventDefault();
          if (
            localStorage.getItem("token") &&
            localStorage.getItem("token") != null
          ) {
            localStorage.removeItem("token");
            const Toast = Swal.mixin({
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 1500,
              timerProgressBar: true,
              didOpen: (toast) => {
                toast.addEventListener("mouseenter", Swal.stopTimer);
                toast.addEventListener("mouseleave", Swal.resumeTimer);
              },
            });

            Toast.fire({
              icon: "success",
              title: "Đăng xuất thành công",
            }).then(() => {
              reload();
            });
          }
        });
      }

      function loadpage() {
        var apitoken = "";
        $.ajax({
          type: "GET",
          url: "https://students.trungthanhweb.com/api/home",
          data: {
            apitoken: apitoken,
          },
          dataType: "JSON",
          success: function (res) {
            var loaiSP = res.categrories;
            var str = ``;
            loaiSP.forEach((el) => {
              str +=
                `
                  <li><a class="dropdown-item" href="#">` +
                el.name +
                `</a></li>
                        `;
            });
            $("#listLSP").html(str);
            var Brands = res.name;
            var str = ``;
            1500;
            loaiSP.forEach((el) => {
              str +=
                `
                  <li><a class="dropdown-item" href="#">` +
                el.name +
                `</a></li>
                        `;
            });
            $("#Brands").html(str);
          },
        });
      }

      function login() {
        $("#loginbtn").click(function (e) {
          var email = $("#email").val().trim();
          if (email == "") {
            const Toast = Swal.mixin({
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 1500,
              timerProgressBar: true,
              didOpen: (toast) => {
                toast.addEventListener("mouseenter", Swal.stopTimer);
                toast.addEventListener("mouseleave", Swal.resumeTimer);
              },
            });

            Toast.fire({
              icon: "error",
              title: "Không thể để trống",
            });
          } else {
            $.ajax({
              type: "post",
              url: "https://students.trungthanhweb.com/api/checkLoginhtml",
              data: { email: email },
              dataType: "JSON",
              success: function (res) {
                if (res.check == true) {
                  console.log(res.apitoken);
                  if (
                    !localStorage.getItem("token") ||
                    localStorage.getItem("token") == null
                  ) {
                    localStorage.setItem("token", res.apitoken);
                  } else {
                    localStorage.removeItem("token");
                    localStorage.setItem("token", res.apitoken);
                  }
                  const Toast = Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                      toast.addEventListener("mouseenter", Swal.stopTimer);
                      toast.addEventListener("mouseleave", Swal.resumeTimer);
                    },
                  });

                  Toast.fire({
                    icon: "success",
                    title: "Đăng nhập thành công",
                  }).then(() => {
                    reload();
                  });
                }
                if (res.msg.email) {
                  const Toast = Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                      toast.addEventListener("mouseenter", Swal.stopTimer);
                      toast.addEventListener("mouseleave", Swal.resumeTimer);
                    },
                  });

                  Toast.fire({
                    icon: "error",
                    title: res.msg.email,
                  });
                }
              },
            });

          }
        });
      }
      function reload() {
        window.location.reload();
      }
    </script>
  </body>
</html>
